# Created by https://github.com/eth0izzle/security-skills/
# W1: Access Control - Stale and Orphaned Account Audit
# Template basis: assets/loop.yaml + conditional (loop with provider routing)
# NIST AC-2 — Identify stale and orphaned user accounts by querying identity
# provider sign-in activity. Supports Entra ID and Okta routing.
# Requires Azure AD app with AuditLog.Read.All, User.Read.All permissions.

name: 'Access Control - Stale and Orphaned Account Audit'
description: >-
  For each user UPN, query the configured identity provider (Entra ID or Okta)
  to retrieve last sign-in activity and account status. Classifies accounts as
  Active, Stale (inactive beyond threshold), or Orphaned (disabled with no
  recent sign-in). Uses HTTP actions to call Graph API or Okta API.
trigger:
    next:
        - check_gate
    name: On demand
    parameters:
        $schema: https://json-schema.org/draft-07/schema
        properties:
            user_upns:
                items:
                    type: string
                type: array
                title: User UPNs
                description: >-
                  List of user principal names (e.g. user@contoso.com) to
                  audit for staleness.
                minItems: 1
            identity_provider:
                type: string
                title: Identity Provider
                description: >-
                  Which identity provider to query for sign-in activity.
                enum:
                    - entra_id
                    - okta
                default: entra_id
            inactivity_threshold_days:
                type: integer
                title: Inactivity Threshold Days
                description: >-
                  Days of inactivity before account is flagged as stale.
                default: 90
            tenant_id:
                type: string
                title: Azure AD Tenant ID
                description: Azure AD tenant ID for Graph API authentication.
            client_id:
                type: string
                title: Azure AD Client ID
                description: Azure AD app registration client ID.
            client_secret:
                type: string
                title: Azure AD Client Secret
                description: Azure AD app registration client secret.
            run_stale_account_audit:
                type: boolean
                title: Run Stale Account Audit
                description: >-
                  Gate flag — set to false to skip this workflow when called
                  from the orchestrator.
                default: true
        required:
            - user_upns
            - tenant_id
            - client_id
            - client_secret
        type: object
    type: On demand
actions:
    GetGraphToken:
        # HTTP action to acquire OAuth2 token from Azure AD
        # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
        id: PLACEHOLDER_HTTP_ACTION_ID
        name: HTTP request
        next:
            - Loop
        properties:
            url: https://login.microsoftonline.com/${data['tenant_id']}/oauth2/v2.0/token
            method: POST
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: >-
              grant_type=client_credentials&client_id=${data['client_id']}&client_secret=${data['client_secret']}&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
        version_constraint: ~1
conditions:
    check_gate:
        next:
            - GetGraphToken
        cel_expression: data['run_stale_account_audit'] == true
        display:
            - Stale account audit is enabled
loops:
    Loop:
        display: For each User UPNs; Sequentially
        name: For each User UPNs; Sequentially
        for:
            input: user_upns
            continue_on_partial_execution: false
            sequential: true
        trigger:
            next:
                - CreateVariable
        actions:
            CreateVariable:
                id: 702d15788dbbffdf0b68d8e2f3599aa4
                class: CreateVariable
                name: Create variable
                next:
                    - is_entra
                    - is_okta
                properties:
                    variable_schema:
                        properties:
                            user_upn:
                                type: string
                            last_sign_in:
                                type: string
                            days_inactive:
                                type: integer
                            is_stale:
                                type: boolean
                            account_enabled:
                                type: boolean
                            classification:
                                type: string
                        required:
                            - user_upn
                            - last_sign_in
                            - days_inactive
                            - is_stale
                            - account_enabled
                            - classification
                        type: object
                version_constraint: ~1
            # ── Entra ID branch ──────────────────────────────────────────
            QueryEntraUser:
                # HTTP GET to Graph API for user sign-in activity.
                # Returns displayName, accountEnabled, and signInActivity
                # (lastSignInDateTime, lastNonInteractiveSignInDateTime).
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - UpdateVariableEntra
                properties:
                    url: >-
                      https://graph.microsoft.com/v1.0/users/${data['user_upns.#']}?$select=displayName,accountEnabled,signInActivity
                    method: GET
                    headers:
                        Authorization: Bearer ${data['GetGraphToken.access_token']}
                        Content-Type: application/json
                version_constraint: ~1
            UpdateVariableEntra:
                id: 6c6eab39063fa3b72d98c82af60deb8a
                class: UpdateVariable
                name: Update variable - Entra ID
                properties:
                    WorkflowCustomVariable:
                        user_upn: ${data['user_upns.#']}
                        last_sign_in: ${data['QueryEntraUser.body.signInActivity.lastSignInDateTime']}
                        days_inactive: ${data['inactivity_threshold_days']}
                        is_stale: true
                        account_enabled: ${data['QueryEntraUser.body.accountEnabled']}
                        classification: Stale
                version_constraint: ~1
            # ── Okta branch ──────────────────────────────────────────────
            QueryOktaUser:
                # HTTP GET to Okta API for user profile and last login.
                # Replace PLACEHOLDER_OKTA_DOMAIN with your Okta org domain.
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - UpdateVariableOkta
                properties:
                    url: >-
                      https://PLACEHOLDER_OKTA_DOMAIN/api/v1/users/${data['user_upns.#']}
                    method: GET
                    headers:
                        Authorization: SSWS PLACEHOLDER_OKTA_API_TOKEN
                        Content-Type: application/json
                version_constraint: ~1
            UpdateVariableOkta:
                id: 6c6eab39063fa3b72d98c82af60deb8a
                class: UpdateVariable
                name: Update variable - Okta
                properties:
                    WorkflowCustomVariable:
                        user_upn: ${data['user_upns.#']}
                        last_sign_in: ${data['QueryOktaUser.body.lastLogin']}
                        days_inactive: ${data['inactivity_threshold_days']}
                        is_stale: true
                        account_enabled: ${data['QueryOktaUser.body.status']}
                        classification: Stale
                version_constraint: ~1
        conditions:
            is_entra:
                next:
                    - QueryEntraUser
                cel_expression: data['identity_provider'] == 'entra_id'
                display:
                    - Identity provider is Entra ID
            is_okta:
                next:
                    - QueryOktaUser
                cel_expression: data['identity_provider'] == 'okta'
                display:
                    - Identity provider is Okta
        output_fields:
            - WorkflowCustomVariable.user_upn
            - WorkflowCustomVariable.last_sign_in
            - WorkflowCustomVariable.days_inactive
            - WorkflowCustomVariable.is_stale
            - WorkflowCustomVariable.account_enabled
            - WorkflowCustomVariable.classification
output_fields:
    - Loop.output
