# Created by https://github.com/eth0izzle/security-skills/
# W4: BEC - Permission and OAuth Review
# PwC Steps 5-6 — Review OAuth app permissions, delegated permissions,
# directory role assignments, and recent app consent events via Graph API.
# Template basis: assets/loop.yaml
# Requires Azure AD app with Directory.Read.All, Application.Read.All permissions.

name: 'BEC - Permission and OAuth Review'
description: >-
  For each compromised user UPN, query Microsoft Graph for OAuth app
  role assignments, delegated permissions, group/role memberships, and
  recent directory audit events. Flags suspicious apps with excessive
  permissions, non-standard M365 apps, and admin role additions.
trigger:
    next:
        - GetGraphToken
    name: On demand
    parameters:
        $schema: https://json-schema.org/draft-07/schema
        properties:
            user_upns:
                items:
                    type: string
                type: array
                title: User UPNs
                description: >-
                  List of user principal names to review for suspicious
                  permissions and OAuth app grants.
                minItems: 1
            tenant_id:
                type: string
                title: Azure AD Tenant ID
                description: Azure AD tenant ID for Graph API authentication.
            client_id:
                type: string
                title: Azure AD Client ID
                description: Azure AD app registration client ID.
            client_secret:
                type: string
                title: Azure AD Client Secret
                description: Azure AD app registration client secret.
            check_oauth_apps:
                type: boolean
                title: Check OAuth Apps
                description: >-
                  Query OAuth app role assignments and delegated permissions.
                  Defaults to true.
                default: true
            check_role_assignments:
                type: boolean
                title: Check Role Assignments
                description: >-
                  Query directory role and group memberships.
                  Defaults to true.
                default: true
        required:
            - user_upns
            - tenant_id
            - client_id
            - client_secret
        type: object
    type: On demand
actions:
    GetGraphToken:
        # HTTP action to acquire OAuth2 token from Azure AD
        # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
        id: PLACEHOLDER_HTTP_ACTION_ID
        name: HTTP request
        next:
            - Loop
        properties:
            url: https://login.microsoftonline.com/${data['tenant_id']}/oauth2/v2.0/token
            method: POST
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: >-
              grant_type=client_credentials&client_id=${data['client_id']}&client_secret=${data['client_secret']}&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
        version_constraint: ~1
loops:
    Loop:
        display: For each User UPNs; Sequentially
        name: For each User UPNs; Sequentially
        for:
            input: user_upns
            continue_on_partial_execution: false
            sequential: true
        trigger:
            next:
                - CreateVariable
        actions:
            CreateVariable:
                id: 702d15788dbbffdf0b68d8e2f3599aa4
                class: CreateVariable
                name: Create variable
                next:
                    - QueryOAuthApps
                properties:
                    variable_schema:
                        properties:
                            user_upn:
                                type: string
                            permission_changes:
                                type: string
                            suspicious_apps:
                                type: string
                            role_changes:
                                type: string
                            findings:
                                type: string
                        required:
                            - user_upn
                        type: object
                version_constraint: ~1
            QueryOAuthApps:
                # HTTP GET — OAuth app role assignments for the user.
                # Detection (PwC Steps 5-6):
                #   - Apps with Mail.Read, MailboxSettings.ReadWrite, Files.ReadWrite.All
                #   - Apps not in the standard M365 app list (PwC p.28 lists 26 default apps)
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - QueryDelegatedPermissions
                properties:
                    url: >-
                      https://graph.microsoft.com/v1.0/users/${data['user_upns.#']}/appRoleAssignments
                    method: GET
                    headers:
                        Authorization: Bearer ${data['GetGraphToken.access_token']}
                        Content-Type: application/json
                version_constraint: ~1
            QueryDelegatedPermissions:
                # HTTP GET — Delegated permissions (OAuth2 permission grants).
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - QueryRoleAssignments
                properties:
                    url: >-
                      https://graph.microsoft.com/v1.0/users/${data['user_upns.#']}/oauth2PermissionGrants
                    method: GET
                    headers:
                        Authorization: Bearer ${data['GetGraphToken.access_token']}
                        Content-Type: application/json
                version_constraint: ~1
            QueryRoleAssignments:
                # HTTP GET — Group and role memberships.
                # Detection (PwC Steps 5-6):
                #   - Recent role additions to admin groups (Global, Exchange, Security admin)
                #   - New user accounts (Add member to role/group events)
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - QueryDirectoryAudits
                properties:
                    url: >-
                      https://graph.microsoft.com/v1.0/users/${data['user_upns.#']}/memberOf
                    method: GET
                    headers:
                        Authorization: Bearer ${data['GetGraphToken.access_token']}
                        Content-Type: application/json
                version_constraint: ~1
            QueryDirectoryAudits:
                # HTTP GET — Recent app consent and application management events.
                # PLACEHOLDER_HTTP_ACTION_ID — run: action_search.py --search "http request"
                id: PLACEHOLDER_HTTP_ACTION_ID
                name: HTTP request
                next:
                    - UpdateVariable
                properties:
                    url: >-
                      https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$filter=category eq 'ApplicationManagement'
                    method: GET
                    headers:
                        Authorization: Bearer ${data['GetGraphToken.access_token']}
                        Content-Type: application/json
                version_constraint: ~1
            UpdateVariable:
                id: 6c6eab39063fa3b72d98c82af60deb8a
                class: UpdateVariable
                name: Update variable
                properties:
                    WorkflowCustomVariable:
                        user_upn: ${data['user_upns.#']}
                        permission_changes: ${data['QueryRoleAssignments.body']}
                        suspicious_apps: ${data['QueryOAuthApps.body']}
                        role_changes: ${data['QueryDirectoryAudits.body']}
                        findings: ${data['QueryDelegatedPermissions.body']}
                version_constraint: ~1
        output_fields:
            - WorkflowCustomVariable.user_upn
            - WorkflowCustomVariable.permission_changes
            - WorkflowCustomVariable.suspicious_apps
            - WorkflowCustomVariable.role_changes
            - WorkflowCustomVariable.findings
output_fields:
    - Loop.output
